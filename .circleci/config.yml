version: 2.1

remote_docker_defaults: &remote_docker_defaults
  docker: [{image: 'docker:17.06-git'}]

basic_docker_build: &basic_docker_build
  name: "Build a really basic docker image"
  command: |
    hostname
    dockerfile=Dockerfile
    echo "FROM alpine:latest" > $dockerfile
    echo "RUN echo hello" >> $dockerfile
    docker network ls
    docker inspect $(docker network ls | grep -w bridge | awk '{print $1}')
    ip route
    docker build -f $dockerfile --tag throwaway:$CIRCLE_BUILD_NUM .
    docker run --rm throwaway:$CIRCLE_BUILD_NUM


jobs:
  # vm jobs
  remote_docker:
    <<: *remote_docker_defaults
    steps:
      - run: |
          echo "PROXY ENV Variables......"
          echo "HTTP PROXY - $HTTP_PROXY"
          echo "HTTPS PROXY - $HTTPS_PROXY"
          echo "NO PROXY - $NO_PROXY"
          echo ""          
          echo "Checking Docker config - "
          cat /etc/systemd/system/docker.service.d/http-proxy.conf || echo "docker config does not exists"
          echo ""
      - run: apk update && apk add sudo
      - run: which docker
      - run: docker -v
      - run: hostname
      - setup_remote_docker   
      - run:
          <<: *basic_docker_build
      - run: docker version


          
## ========================================================================
##                WORKFLOW
## ========================================================================
workflows:
  version: 2

  remote_docker:
    jobs:
      - remote_docker

